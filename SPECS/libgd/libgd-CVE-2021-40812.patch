From e5c84f0b7a2e2cef8d8630bd8c26a2f859e959ff Mon Sep 17 00:00:00 2001
From: Pierre Joye <pierre.php@gmail.com>
Date: Tue, 7 Sep 2021 22:03:21 +0700
Subject: [PATCH] Partial fix for #750

---
 src/gd_bmp.c  | 14 +++++++++++---
 src/gd_webp.c |  6 +++++-
 2 files changed, 16 insertions(+), 4 deletions(-)

diff --git a/src/gd_bmp.c b/src/gd_bmp.c
index 34494ff..bdc0aad 100755
--- a/src/gd_bmp.c
+++ b/src/gd_bmp.c
@@ -30,6 +30,7 @@
 #include <stdlib.h>
 #include "gd.h"
 #include "gdhelpers.h"
+#include "gd_errors.h"
 #include "bmp.h"
 
 static int compress_row(unsigned char *uncompressed_row, int length);
@@ -266,7 +267,11 @@ static int _gdImageBmpCtx(gdImagePtr im, gdIOCtxPtr out, int compression)
 				bitmap_size += compressed_size;
 
 
-				gdPutBuf(uncompressed_row, compressed_size, out);
+                                if (gdPutBuf(uncompressed_row, compressed_size, out) != compressed_size){
+					gd_error("gd-bmp write error\n");
+					error = 1;
+					break;
+				}
 				Putchar(BMP_RLE_COMMAND, out);
 				Putchar(BMP_RLE_ENDOFLINE, out);
 				bitmap_size += 2;
@@ -325,7 +330,10 @@ static int _gdImageBmpCtx(gdImagePtr im, gdIOCtxPtr out, int compression)
 			if (buffer_size == 0) {
 				break;
 			}
-			gdPutBuf(copy_buffer , buffer_size, out_original);
+                        if (gdPutBuf(copy_buffer , buffer_size, out_original) != buffer_size) {
+				gd_error("gd-bmp write error\n");
+				error = 1;
+			}
 		}
 		gdFree(copy_buffer);
 
@@ -335,7 +343,7 @@ static int _gdImageBmpCtx(gdImagePtr im, gdIOCtxPtr out, int compression)
 		out_original = NULL;
 	}
 
-	ret = 0;
+	ret = error;
 cleanup:
 	if (tmpfile_for_compression) {
 #ifdef _WIN32
diff --git a/src/gd_webp.c b/src/gd_webp.c
index b5ee264..09360ea 100755
--- a/src/gd_webp.c
+++ b/src/gd_webp.c
@@ -222,8 +222,12 @@ static int _gdImageWebpCtx (gdImagePtr im, gdIOCtx * outfile, int quality)
         ret = 1;
 		goto freeargb;
 	}
-	gdPutBuf(out, out_size, outfile);
+	int res = gdPutBuf(out, out_size, outfile);
 	free(out);
+        if (res != out_size) {
+		gd_error("gd-webp write error\n");
+		ret = 1;
+	}
 
 freeargb:
 	gdFree(argb);
