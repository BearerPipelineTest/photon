diff --git a/numpy/f2py/src/fortranobject.c b/numpy/f2py/src/fortranobject.c
index 9024dd5..4eeba1e 100644
--- a/numpy/f2py/src/fortranobject.c
+++ b/numpy/f2py/src/fortranobject.c
@@ -594,12 +594,12 @@ static void f2py_report_on_array_copy_fromany(void) {
 static int
 count_nonpos(const int rank,
              const npy_intp *dims) {
-    int i=0,r=0;
-    while (i<rank) {
-        if (dims[i] <= 0) ++r;
-        ++i;
+   for (int i = 0; i < rank; ++i) {
+        if (dims[i] < 0) {
+            return i;
+        }
     }
-    return r;
+    return -1;
 }
 
 static int check_and_fix_dimensions(const PyArrayObject* arr,
diff --git a/numpy/f2py/src/fortranobject.c b/numpy/f2py/src/fortranobject.c
index c07de99..608f122 100644
--- a/numpy/f2py/src/fortranobject.c
+++ b/numpy/f2py/src/fortranobject.c
@@ -617,14 +617,12 @@ PyArrayObject* array_from_pyobj(const int type_num,
         || ((intent & F2PY_OPTIONAL) && (obj==Py_None))
         ) {
         /* intent(cache), optional, intent(hide) */
-        if (count_nonpos(rank,dims)) {
-            int i;
-            sprintf(mess,"failed to create intent(cache|hide)|optional array"
-                    "-- must have defined dimensions but got (");
-            for(i=0;i<rank;++i)
-                sprintf(mess+strlen(mess),"%" NPY_INTP_FMT ",",dims[i]);
-            sprintf(mess+strlen(mess),")");
-            PyErr_SetString(PyExc_ValueError,mess);
+        int i = count_nonpos(rank, dims);
+        if (i >= 0) {
+            PyErr_Format(PyExc_ValueError,
+                         "failed to create intent(cache|hide)|optional array"
+                         " -- must have defined dimensions, but dims[%d] = %"
+                         NPY_INTP_FMT, i, dims[i]);
             return NULL;
         }
         arr = (PyArrayObject *)


         ) {
