From 01faddbe2711a4156180c4a92837e2f23683cc68 Mon Sep 17 00:00:00 2001
From: Dirk Lemstra <dirk@lemstra.org>
Date: Sat, 11 Sep 2021 17:00:50 +0200
Subject: [PATCH] Use the correct rights.

---
 MagickCore/module.c | 2 +-
 MagickCore/static.c | 8 ++++++--
 2 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/MagickCore/module.c b/MagickCore/module.c
index 33b8fca..cb5bd5e 100644
--- a/MagickCore/module.c
+++ b/MagickCore/module.c
@@ -1251,7 +1251,7 @@ MagickPrivate MagickBooleanType OpenModule(const char *module,
   module_info=(ModuleInfo *) GetModuleInfo(module,exception);
   if (module_info != (ModuleInfo *) NULL)
     return(MagickTrue);
-  rights=ReadPolicyRights;
+  rights=ReadPolicyRights|WritePolicyRights;
   if (IsRightsAuthorized(ModulePolicyDomain,rights,module) == MagickFalse)
     {
       errno=EPERM;
diff --git a/MagickCore/static.c b/MagickCore/static.c
index 3f43ada..9100d4c 100644
--- a/MagickCore/static.c
+++ b/MagickCore/static.c
@@ -236,7 +236,7 @@ MagickExport MagickBooleanType RegisterStaticModule(const char *module,
     Assign module name from alias.
   */
   assert(module != (const char *) NULL);
-  rights=ReadPolicyRights;
+  rights=ReadPolicyRights|WritePolicyRights;
   if (IsRightsAuthorized(ModulePolicyDomain,rights,module) == MagickFalse)
     {
       errno=EPERM;
@@ -283,17 +283,24 @@ MagickExport MagickBooleanType RegisterStaticModule(const char *module,
 */
 MagickExport void RegisterStaticModules(void)
 {
+  PolicyRights
+    rights;
+
   size_t
     extent;
 
   ssize_t
     i;
 
+  rights=ReadPolicyRights|WritePolicyRights;
   extent=sizeof(MagickModules)/sizeof(MagickModules[0]);
   for (i=0; i < (ssize_t) extent; i++)
   {
     if (MagickModules[i].registered == MagickFalse)
       {
+        if (IsRightsAuthorized(ModulePolicyDomain,rights,
+              MagickModules[i].module) == MagickFalse)
+          continue;
         (void) (MagickModules[i].register_module)();
         MagickModules[i].registered=MagickTrue;
       }
