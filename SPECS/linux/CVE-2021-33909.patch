seq_file: Disallow extremely large seq buffer allocations

There is no reasonable need for a buffer larger than this,
and it avoids int overflow pitfalls.

Suggested-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Eric Sandeen <sandeen@redhat.com>

---
 fs/seq_file.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/fs/seq_file.c b/fs/seq_file.c
index 6dc4296eed62..85bf4eea854b 100644
--- a/fs/seq_file.c
+++ b/fs/seq_file.c
@@ -14,6 +14,7 @@
 #include <linux/mm.h>
 #include <linux/printk.h>
 #include <linux/string_helpers.h>
+#include <linux/pagemap.h>

 #include <asm/uaccess.h>
 #include <asm/page.h>
@@ -34,6 +35,9 @@ static void *seq_buf_alloc(unsigned long size)
 	 * allocations, just use GFP_KERNEL which will oom kill, thus no need
 	 * for vmalloc fallback.
 	 */
+	if (unlikely(size > MAX_RW_COUNT))
+		return NULL;
+
 	if (size > PAGE_SIZE)
 		gfp |= __GFP_NORETRY | __GFP_NOWARN;
 	buf = kmalloc(size, gfp);
--
2.17.1

