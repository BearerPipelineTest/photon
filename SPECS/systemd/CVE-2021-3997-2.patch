From 6de4e26f6e8369dbf7a32b2c39d4cff0dc4b8d2f Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Zbigniew=20J=C4=99drzejewski-Szmek?= <zbyszek@in.waw.pl>
Date: Sat, 8 Jan 2022 15:36:14 +0530
Subject: [PATCH 2/5] shared/rm_rf: refactor rm_rf_children_inner() to shorten
 code a bit

---
 src/basic/rm-rf.c | 27 +++++++++------------------
 1 file changed, 9 insertions(+), 18 deletions(-)

diff --git a/src/basic/rm-rf.c b/src/basic/rm-rf.c
index 81ee5c37ba..33b6804be1 100644
--- a/src/basic/rm-rf.c
+++ b/src/basic/rm-rf.c
@@ -124,7 +124,7 @@ static int rm_rf_children_inner(
                 const struct stat *root_dev) {
 
         struct stat st;
-        int r;
+        int r, q = 0;
 
         assert(fd >= 0);
         assert(fname);
@@ -142,7 +142,6 @@ static int rm_rf_children_inner(
 
         if (is_dir) {
                 _cleanup_close_ int subdir_fd = -1;
-                int q;
 
                 /* if root_dev is set, remove subdirectories only if device is same */
                 if (root_dev && st.st_dev != root_dev->st_dev)
@@ -178,23 +177,15 @@ static int rm_rf_children_inner(
                  * again for each directory */
                 q = rm_rf_children(TAKE_FD(subdir_fd), flags | REMOVE_PHYSICAL, root_dev);
 
-                r = unlinkat_harder(fd, fname, AT_REMOVEDIR, flags);
-                if (r < 0)
-                        return r;
-                if (q < 0)
-                        return q;
-
-                return 1;
-
-        } else if (!(flags & REMOVE_ONLY_DIRECTORIES)) {
-                r = unlinkat_harder(fd, fname, 0, flags);
-                if (r < 0)
-                        return r;
-
-                return 1;
-        }
+        } else if (flags & REMOVE_ONLY_DIRECTORIES)
+                return 0;
 
-        return 0;
+        r = unlinkat_harder(fd, fname, is_dir ? AT_REMOVEDIR : 0, flags);
+        if (r < 0)
+                return r;
+        if (q < 0)
+                return q;
+        return 1;
 }
 
 int rm_rf_children(
-- 
2.33.1

